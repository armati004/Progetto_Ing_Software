classDiagram
    %% ===================================
    %% PACKAGE: carte
    %% ===================================
    
    class Carta {
        -String nome
        -String id
        -String classe
        -String descrizione
        -int costo
        -String pathImmagine
        -List~Effetto~ effetti
        -List~Trigger~ triggers
        +Carta(nome, id, classe, descrizione, costo, pathImmagine, effetti, triggers)
        +applicaEffetto(StatoDiGioco, Giocatore)
        +getNome() String
        +getId() String
        +getClasse() String
        +getDescrizione() String
        +getCosto() int
        +getPathImmagine() String
        +getEffetti() List~Effetto~
        +getTriggers() List~Trigger~
    }
    
    class Eroe {
        +Eroe(nome, id, classe, descrizione, costo, pathImmagine, effetti, triggers)
        +applicaEffetto(StatoDiGioco, Giocatore)
    }
    
    class Alleato {
        +Alleato(nome, id, classe, descrizione, costo, pathImmagine, effetti, triggers)
    }
    
    class Incantesimo {
        +Incantesimo(nome, id, classe, descrizione, costo, pathImmagine, effetti, triggers)
    }
    
    class Oggetto {
        +Oggetto(nome, id, classe, descrizione, costo, pathImmagine, effetti, triggers)
    }
    
    class ArteOscura {
        +ArteOscura(nome, id, classe, descrizione, costo, pathImmagine, effetti, triggers)
    }
    
    class Competenza {
        -Boolean attivabile
        -String commento
        +Competenza(nome, id, classe, descrizione, pathImmagine, attivabile, effetti, triggers, commento)
        +isAttivabile() Boolean
        +getCommento() String
    }
    
    class Luogo {
        -int numeroMarchiNeri
        -int nDarkEvents
        -int marchiNeriMax
        -Effetto effettoEntrata
        +Luogo(nome, id, classe, descrizione, costo, pathImmagine, effetti, triggers, numeroMarchiNeri, nDarkEvents, marchiNeriMax, effettoEntrata)
        +aggiungiMarchioNero(Integer) boolean
        +rimuoviMarchioNero(Integer)
        +getNumeroMarchiNeri() int
        +getMarchiNeriMax() int
    }
    
    class Malvagio {
        -int vita
        -int danno
        -List~Effetto~ reward
        -Boolean bloccoAbilita
        -Giocatore giocatoreBloccante
        -Boolean attaccoassegnato
        +Malvagio(nome, id, classe, descrizione, costo, pathImmagine, effetti, triggers, reward, vita)
        +defeat(StatoDiGioco, Giocatore)
        +isSconfitto() boolean
        +getDanno() int
        +getVita() int
        +getReward() List~Effetto~
    }
    
    class Horcrux {
        -int difesa
        -List~Effetto~ reward
        +Horcrux(nome, id, classe, descrizione, costo, pathImmagine, effetti, triggers, difesa, reward)
        +getDifesa() int
        +getReward() List~Effetto~
    }
    
    class Mazzo {
        -List~Carta~ carte
        +Mazzo()
        +pescaCarta() Carta
        +aggiuntaCarta(Carta)
        +mescola()
        +getCarte() List~Carta~
        +isEmpty() boolean
        +size() int
    }
    
    class Dado {
        -String id
        -String nome
        -List~String~ facce
        +Dado(id, nome, facce)
        +lancia() String
        +getId() String
        +getNome() String
        +getFacce() List~String~
    }
    
    %% Relazioni gerarchiche carte
    Carta <|-- Eroe
    Carta <|-- Alleato
    Carta <|-- Incantesimo
    Carta <|-- Oggetto
    Carta <|-- ArteOscura
    Carta <|-- Competenza
    Carta <|-- Luogo
    Carta <|-- Malvagio
    Carta <|-- Horcrux
    
    %% ===================================
    %% PACKAGE: gioco
    %% ===================================
    
    class Giocatore {
        -Eroe eroe
        -int salute
        -int saluteMax
        -Mazzo mazzo
        -Mazzo scarti
        -List~Carta~ mano
        -int gettone
        -int attacco
        -Competenza competenza
        -int alleatiGiocati
        -int incantesimiGiocati
        -int oggettiGiocati
        -SelettoreCarta selettoreCarta
        -List~Carta~ carteAcquistateQuestoTurno
        +Giocatore(Eroe)
        +inizializzaMano()
        +giocaCarta(StatoDiGioco, Carta)
        +acquistaCarta(List~Carta~, Carta, StatoDiGioco)
        +scartaCarta(Carta)
        +pescaCarta()
        +riceviDanno(int, StatoDiGioco)
        +guarisci(int)
        +registraTriggersInMano(StatoDiGioco)
        +rimuoviTriggersCartaDaMano(StatoDiGioco, Carta)
        +getEroe() Eroe
        +getSalute() int
        +getMano() List~Carta~
        +getGettone() int
        +getAttacco() int
        +getCompetenza() Competenza
    }
    
    class StatoDiGioco {
        -int annoCorrente
        -FaseTurno faseCorrente
        -boolean gameOver
        -boolean victory
        -boolean vittoriaPendente
        -List~Giocatore~ giocatori
        -int giocatoreCorrente
        -Luogo currentLocation
        -LinkedList~Luogo~ listaLuoghi
        -LinkedList~Carta~ mazzoNegozio
        -LinkedList~Malvagio~ mazzoMalvagi
        -LinkedList~ArteOscura~ mazzoArtiOscure
        -LinkedList~Horcrux~ mazzoHorcrux
        -List~Carta~ mercato
        -List~Malvagio~ malvagiAttivi
        -List~Horcrux~ horcruxAttivi
        -GestoreEffetti gestoreEffetti
        -GestoreTrigger gestoreTrigger
        -Map~String,Dado~ dadi
        -Map~Malvagio,Integer~ attacchiAssegnati
        -Set~String~ carteAcquisiteDaiGiocatori
        +StatoDiGioco(GameConfig, List~Giocatore~)
        +inizializzaMazzi()
        +rifornisciMercato()
        +addMalvagioAttivo()
        +applicaAttacchi()
        +resetAttacchi()
        +sconfiggiMalvagio(Malvagio)
        +checkVittoria()
        +checkGameOver()
        +getAnnoCorrente() int
        +getFaseCorrente() FaseTurno
        +getGiocatori() List~Giocatore~
        +getMercato() List~Carta~
        +getMalvagiAttivi() List~Malvagio~
        +getGestoreEffetti() GestoreEffetti
        +getGestoreTrigger() GestoreTrigger
    }
    
    class TurnManager {
        -StatoDiGioco stato
        +TurnManager(StatoDiGioco)
        +iniziaTurno()
        +eseguiFaseAutomatica()
        +eseguiFaseArtiOscure()
        +eseguiFaseMalvagi()
        +eseguiFaseHorcrux()
        +eseguiFineTurno()
        +passaAllaFaseSuccessiva()
    }
    
    class FaseTurno {
        <<enumeration>>
        ARTI_OSCURE
        MALVAGI
        HORCRUX
        GIOCA_CARTE
        ATTACCA
        ACQUISTA_CARTE
        FINE_TURNO
    }
    
    class GameController {
        -StatoDiGioco stato
        -TurnManager turnManager
        -GameBoardUI gameUI
        +GameController()
        +iniziaPartita()
        +giocaCarta(int)
        +acquistaCarta(int)
        +attaccaMalvagio(int)
        +passaFase()
        +terminaTurno()
    }
    
    %% Relazioni gioco
    Giocatore --> Eroe : has
    Giocatore --> Mazzo : has 2
    Giocatore --> Competenza : has
    Giocatore *-- Carta : mano
    StatoDiGioco *-- Giocatore : gestisce
    StatoDiGioco *-- Luogo : current
    StatoDiGioco *-- Carta : mercato
    StatoDiGioco *-- Malvagio : attivi
    StatoDiGioco --> FaseTurno : usa
    TurnManager --> StatoDiGioco : gestisce
    GameController --> StatoDiGioco : controlla
    GameController --> TurnManager : usa
    
    %% ===================================
    %% PACKAGE: gestoreEffetti
    %% ===================================
    
    class Effetto {
        -TipoEffetto type
        -Integer qta
        -BersaglioEffetto target
        -DurataEffetto durata
        -List~Effetto~ opzioni
        -Integer minValue
        -List~Effetto~ effectsIfTrue
        +Effetto(type, qta, target, durata, opzioni, minValue, effectsIfTrue)
        +getType() TipoEffetto
        +getQta() Integer
        +getTarget() BersaglioEffetto
        +getDurata() DurataEffetto
        +getOpzioni() List~Effetto~
    }
    
    class TipoEffetto {
        <<enumeration>>
        GUADAGNARE_ATTACCO
        GUADAGNARE_INFLUENZA
        GUADAGNARE_VITA
        PERDERE_VITA
        PESCARE_CARTA
        SCARTARE_CARTA
        SCARTA_INCANTESIMO
        SCARTA_OGGETTO
        SCARTA_ALLEATO
        SCELTA
        SCELTA_MULTIPLA
        CONDIZIONALE
    }
    
    class BersaglioEffetto {
        <<enumeration>>
        EROE_ATTIVO
        TUTTI_GLI_EROI
        EROI_NON_ATTIVI
        TUTTI_I_MALVAGI
        LUOGO
    }
    
    class DurataEffetto {
        <<enumeration>>
        ISTANTANEO
        TEMPORANEO
        CONTINUO
    }
    
    class Trigger {
        -TipoTrigger type
        -List~Effetto~ effectToExecute
        -DurataEffetto durata
        +Trigger(type, effectToExecute, durata)
        +getType() TipoTrigger
        +getEffectToExecute() List~Effetto~
        +getDurata() DurataEffetto
    }
    
    class TipoTrigger {
        <<enumeration>>
        ACQUISTO_ALLEATO
        ACQUISTO_INCANTESIMO
        ACQUISTO_OGGETTO
        GIOCA_ALLEATO
        GIOCA_INCANTESIMO
        GIOCA_OGGETTO
        RICEVI_DANNO
        GUADAGNA_VITA
        NEMICO_SCONFITTO
        INIZIO_TURNO
        FINE_TURNO
        AUTO_SCARTO
    }
    
    class EsecutoreEffetti {
        <<utility>>
        +eseguiEffetto(Effetto, StatoDiGioco, Giocatore, Carta)$ void
        -gestisciScelta(Effetto, StatoDiGioco, Giocatore, Carta)$ void
        -gestisciSceltaMultipla(Effetto, StatoDiGioco, Giocatore, Carta)$ void
        -gestisciCondizionale(Effetto, StatoDiGioco, Giocatore, Carta)$ void
    }
    
    class GestoreEffetti {
        -Map~TipoEffetto,List~Carta~~ effettiAttivi
        -Map~TipoEffetto,List~Carta~~ effettiTemporanei
        +GestoreEffetti()
        +aggiungiEffetto(TipoEffetto, Carta)
        +aggiungiEffettoTemporaneo(TipoEffetto, Carta)
        +rimuoviEffetto(TipoEffetto, Carta)
        +calcolaBonusAttacco() int
        +calcolaBonusInfluenza() int
        +pulisciEffettiTemporanei()
    }
    
    class GestoreTrigger {
        -Map~TipoTrigger,List~RegistrazioneTrigger~~ triggersRegistrati
        +GestoreTrigger()
        +registraTrigger(TipoTrigger, List~Effetto~, Carta, DurataEffetto)
        +attivaTrigger(TipoTrigger, StatoDiGioco, Giocatore)
        +rimuoviTrigger(Carta)
        +pulisciTriggerTemporanei()
    }
    
    class RegistrazioneTrigger {
        -List~Effetto~ effetti
        -Carta fonte
        -DurataEffetto durata
        +RegistrazioneTrigger(effetti, fonte, durata)
    }
    
    %% Relazioni gestoreEffetti
    Carta *-- Effetto : has
    Carta *-- Trigger : has
    Effetto --> TipoEffetto : usa
    Effetto --> BersaglioEffetto : usa
    Effetto --> DurataEffetto : usa
    Trigger --> TipoTrigger : usa
    Trigger --> DurataEffetto : usa
    Trigger *-- Effetto : contiene
    GestoreEffetti --> Carta : traccia
    GestoreTrigger *-- RegistrazioneTrigger : gestisce
    RegistrazioneTrigger --> Carta : riferisce
    StatoDiGioco --> GestoreEffetti : has
    StatoDiGioco --> GestoreTrigger : has
    
    %% ===================================
    %% PACKAGE: data (Factory & Loader)
    %% ===================================
    
    class CardFactory {
        <<utility>>
        -Map~String,Carta~ registroCarte$
        -boolean inizializzata$
        +inizializza()$ void
        +creaCarta(String)$ Carta
        -caricaCarte(String)$ void
    }
    
    class HeroFactory {
        <<utility>>
        -Map~String,Map~Integer,Eroe~~ registroEroi$
        +inizializza()$ void
        +creaEroe(String, int)$ Eroe
        -caricaEroi(String)$ void
    }
    
    class VillainFactory {
        <<utility>>
        -Map~Integer,List~Malvagio~~ registroMalvagi$
        +inizializza()$ void
        +getMalvagiPerAnno(int)$ List~Malvagio~
    }
    
    class LocationFactory {
        <<utility>>
        -Map~Integer,List~Luogo~~ registroLuoghi$
        +inizializza()$ void
        +getLuoghiPerAnno(int)$ List~Luogo~
    }
    
    class HorcruxFactory {
        <<utility>>
        -Map~String,Horcrux~ registroHorcrux$
        +inizializza()$ void
        +creaHorcrux(String)$ Horcrux
    }
    
    class ProficiencyFactory {
        <<utility>>
        -Map~String,Map~Integer,Competenza~~ registroCompetenze$
        +inizializza()$ void
        +creaCompetenza(String, int)$ Competenza
    }
    
    class DiceFactory {
        <<utility>>
        -Map~String,Dado~ registroDadi$
        +inizializza()$ void
        +creaDado(String)$ Dado
    }
    
    class StarterPackLoader {
        <<utility>>
        -Map~String,List~String~~ starterDeckMap$
        +inizializza()$ void
        +getStarterDeckIds(String)$ List~String~
    }
    
    class GameConfig {
        -int anno
        -List~String~ eroi
        -boolean contieneHorcrux
        +GameConfig(anno, eroi, contieneHorcrux)
        +getAnno() int
        +getEroi() List~String~
        +getContieneHorcrux() boolean
    }
    
    class GameLoader {
        <<utility>>
        +caricaGioco(GameConfig)$ StatoDiGioco
        -inizializzaGiocatori(GameConfig)$ List~Giocatore~
    }
    
    class Anno {
        <<utility>>
        +caricaAnno(int)$ GameConfig
    }
    
    %% Relazioni data
    CardFactory ..> Carta : crea
    HeroFactory ..> Eroe : crea
    VillainFactory ..> Malvagio : crea
    LocationFactory ..> Luogo : crea
    HorcruxFactory ..> Horcrux : crea
    ProficiencyFactory ..> Competenza : crea
    DiceFactory ..> Dado : crea
    GameLoader --> GameConfig : usa
    GameLoader ..> StatoDiGioco : crea
    Anno ..> GameConfig : crea
    
    %% ===================================
    %% PACKAGE: grafica
    %% ===================================
    
    class GameBoardUI {
        -BorderPane root
        -GameBoardPanel boardPanel
        -MessagePanel messagePanel
        -PlayersStatsPanel statsPanel
        -CurrentPlayerPanel currentPlayerPanel
        -StatoDiGioco stato
        +GameBoardUI(StatoDiGioco)
        +aggiorna()
        +getScene() Scene
        +getMessagePanel() MessagePanel
    }
    
    class GameBoardPanel {
        -VBox mainContainer
        -StatoDiGioco stato
        +GameBoardPanel(StatoDiGioco)
        +aggiorna()
        -creaSezioneVillains() VBox
        -creaSezioneMercato() VBox
    }
    
    class MessagePanel {
        -VBox container
        -Label messageLabel
        +MessagePanel()
        +mostraMessaggio(String, TipoMessaggio)
        +pulisci()
    }
    
    class PlayersStatsPanel {
        -HBox container
        -StatoDiGioco stato
        +PlayersStatsPanel(StatoDiGioco)
        +aggiorna()
    }
    
    class CurrentPlayerPanel {
        -VBox container
        -Giocatore giocatore
        +CurrentPlayerPanel(Giocatore)
        +aggiorna()
        -creaSezioneMano() VBox
    }
    
    class CardButton {
        -Button button
        -Carta carta
        +CardButton(Carta)
        +getButton() Button
        +getCarta() Carta
    }
    
    class CardClickHandler {
        <<interface>>
        +handleCardClick(Carta, String)* void
    }
    
    class DialogHelper {
        <<utility>>
        +mostraMessaggio(String, String, String)$ void
        +mostraScelta(String, String, String, String, String, Consumer)$ void
        +mostraInputNumerico(String, String, String, int, int, Consumer)$ void
        +mostraSceltaEffetto(String, String, String, String, String, Consumer)$ void
        +mostraTriggerAttivato(String, String, String, Runnable)$ void
    }
    
    class ImageLoader {
        <<utility>>
        +caricaImmagine(String)$ Image
        -caricaDaClasspath(String)$ Image
        -caricaDaJSON(String, String)$ Image
        +createPlaceholder(int, int)$ Image
    }
    
    %% Relazioni grafica
    GameBoardUI *-- GameBoardPanel : contiene
    GameBoardUI *-- MessagePanel : contiene
    GameBoardUI *-- PlayersStatsPanel : contiene
    GameBoardUI *-- CurrentPlayerPanel : contiene
    GameBoardUI --> StatoDiGioco : visualizza
    GameBoardPanel --> StatoDiGioco : visualizza
    CurrentPlayerPanel --> Giocatore : visualizza
    CardButton --> Carta : rappresenta
    GameController --> GameBoardUI : usa
    
    %% ===================================
    %% PACKAGE: persistence
    %% ===================================
    
    class SaveManager {
        <<utility>>
        +salvaGioco(StatoDiGioco, String)$ void
        +caricaGioco(String)$ StatoDiGioco
    }
    
    class GameSaveData {
        -int anno
        -List~PlayerSaveData~ giocatori
        -int giocatoreCorrente
        -String faseCorrente
        -List~String~ mercatoIds
        -List~String~ malvagiAttiviIds
        +GameSaveData(anno, giocatori, giocatoreCorrente, faseCorrente, mercatoIds, malvagiAttiviIds)
    }
    
    class PlayerSaveData {
        -String nomeEroe
        -int salute
        -List~String~ mazzoIds
        -List~String~ scartiIds
        -List~String~ manoIds
        -String competenzaId
        +PlayerSaveData(nomeEroe, salute, mazzoIds, scartiIds, manoIds, competenzaId)
    }
    
    class ProgressionManager {
        <<utility>>
        +puoAvanzareAnno(int)$ boolean
        +calcolaProssimoAnno(int)$ int
        +ricreaGiocatoriDaSalvataggio(GameSaveData, int)$ List~Giocatore~
    }
    
    %% Relazioni persistence
    SaveManager ..> GameSaveData : crea
    GameSaveData *-- PlayerSaveData : contiene
    SaveManager ..> StatoDiGioco : salva/carica
    ProgressionManager ..> GameSaveData : usa
    ProgressionManager ..> Giocatore : ricrea
    
    %% ===================================
    %% PACKAGE: meccanica (utility)
    %% ===================================
    
    class Meccanica {
        <<utility>>
        +calcolaValoreCondizionale(Giocatore, Effetto)$ int
        +verificaCondizione(int, int)$ boolean
    }
    
    class SelettoreCarta {
        <<interface>>
        +selezionaCarta(List~Carta~)* Carta
    }
    
    class InputController {
        <<utility>>
        +chiediSceltaEffetto(Effetto, Giocatore, StatoDiGioco)$ int
        +chiediSceltaMalvagio(StatoDiGioco)$ Malvagio
        +chiediSceltaGiocatore(List~Giocatore~, Giocatore)$ Giocatore
        +chiediSceltaCarta(List~Carta~, String)$ Carta
    }
    
    %% Relazioni meccanica
    Giocatore --> SelettoreCarta : usa
    EsecutoreEffetti --> InputController : usa
    EsecutoreEffetti --> Meccanica : usa
    
    %% Note di design
    note for Carta "Classe base astratta per tutte le carte del gioco.\nContiene effetti e trigger che definiscono il comportamento."
    note for StatoDiGioco "Mantiene lo stato completo della partita:\n- Giocatori e turno corrente\n- Mazzi e carte attive\n- Gestori per effetti e trigger"
    note for EsecutoreEffetti "Singleton che esegue gli effetti delle carte.\nGestisce scelte, condizioni e applicazione effetti."
    note for GestoreTrigger "Gestisce i trigger registrati dalle carte.\nAttiva trigger in risposta a eventi di gioco."
